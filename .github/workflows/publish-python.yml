name: Publish Python Packages to PyPI

on:
  release:
    types: [published]

  workflow_dispatch:
    inputs:
      package-name:
        description: >
          Optional: a single package directory name to publish (e.g. "jamaica-trn").
          Leave blank to publish ALL packages.
        required: false
        type: string

# Trusted-publisher (OIDC) requires id-token: write.
# contents: read is needed to check out the repo.
permissions:
  id-token: write
  contents: read

concurrency:
  group: publish-python-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ---------------------------------------------------------------------------
  # 1. Discover which packages to build & publish
  # ---------------------------------------------------------------------------
  discover:
    name: Discover packages
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.list.outputs.packages }}
    steps:
      - uses: actions/checkout@v4

      - name: Build package matrix
        id: list
        run: |
          if [[ -n "${{ inputs.package-name }}" ]]; then
            # workflow_dispatch with an explicit package name
            pkg="${{ inputs.package-name }}"
            dir="toolkit/${pkg}/python"
            if [[ ! -f "${dir}/pyproject.toml" ]]; then
              echo "::error::Package directory ${dir} does not contain a pyproject.toml"
              exit 1
            fi
            echo "packages=[\"${dir}\"]" >> "$GITHUB_OUTPUT"
          else
            # Publish every toolkit Python package listed in the workspace
            packages=$(
              grep -oP 'toolkit/[^"]+/python' pyproject.toml \
              | sort -u \
              | jq -R -s -c 'split("\n") | map(select(length > 0))'
            )
            echo "packages=${packages}" >> "$GITHUB_OUTPUT"
          fi

      - name: Show discovered packages
        run: echo '${{ steps.list.outputs.packages }}'

  # ---------------------------------------------------------------------------
  # 2. Build & publish each package in parallel
  # ---------------------------------------------------------------------------
  publish:
    name: "Publish ${{ matrix.package }}"
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.discover.outputs.packages) }}

    # PyPI trusted-publisher environment (configure in PyPI project settings)
    environment:
      name: pypi
      url: https://pypi.org/project/${{ steps.meta.outputs.name }}/

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Extract package metadata
        id: meta
        working-directory: ${{ matrix.package }}
        run: |
          name=$(python -c "
          import tomllib, pathlib
          data = tomllib.loads(pathlib.Path('pyproject.toml').read_text())
          print(data['project']['name'])
          ")
          version=$(python -c "
          import tomllib, pathlib
          data = tomllib.loads(pathlib.Path('pyproject.toml').read_text())
          print(data['project']['version'])
          ")
          echo "name=${name}"       >> "$GITHUB_OUTPUT"
          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "### ${name} v${version}" >> "$GITHUB_STEP_SUMMARY"

      - name: Check if version already exists on PyPI
        id: check
        run: |
          status=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://pypi.org/pypi/${{ steps.meta.outputs.name }}/${{ steps.meta.outputs.version }}/json")
          if [[ "${status}" == "200" ]]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "::notice::${{ steps.meta.outputs.name }} v${{ steps.meta.outputs.version }} already on PyPI — skipping."
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Build package
        if: steps.check.outputs.exists == 'false'
        working-directory: ${{ matrix.package }}
        run: uv build --out-dir dist/

      - name: Publish to PyPI (trusted publisher / OIDC)
        if: steps.check.outputs.exists == 'false'
        working-directory: ${{ matrix.package }}
        run: uv publish dist/*
        # uv publish uses OIDC by default when id-token permission is granted.
        # If trusted publishing is not configured for a package on PyPI, the
        # step will fail and the fallback below will try token-based auth.
        id: trusted
        continue-on-error: true

      - name: Publish to PyPI (fallback — API token)
        if: steps.check.outputs.exists == 'false' && steps.trusted.outcome == 'failure'
        working-directory: ${{ matrix.package }}
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_TOKEN }}
        run: |
          if [[ -z "${UV_PUBLISH_TOKEN}" ]]; then
            echo "::error::Trusted publishing failed and PYPI_TOKEN secret is not set."
            exit 1
          fi
          echo "::warning::Trusted publishing failed — falling back to PYPI_TOKEN secret."
          uv publish dist/*

      - name: Summary
        if: steps.check.outputs.exists == 'false'
        run: |
          echo "Published **${{ steps.meta.outputs.name }}** \
          v${{ steps.meta.outputs.version }} to PyPI." >> "$GITHUB_STEP_SUMMARY"
